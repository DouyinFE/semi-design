name: React Multi-Version Build and Publish

on:
  push:
    branches: [main, release/*]
  pull_request:
    branches: [main]

jobs:
  test-react-18:
    name: Test with React 18
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: Run tests with React 18
        run: |
          yarn test
          yarn build
          
  test-react-19:
    name: Test with React 19
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'
          
      - name: Install dependencies with React 19
        run: |
          yarn install --frozen-lockfile
          # 升级到 React 19 预发布版本
          yarn add react@beta react-dom@beta --dev
          
      - name: Build React 19 compatible version
        run: |
          node scripts/react19-build.js 19
          
      - name: Test React 19 version
        run: |
          # 在这里运行适合 React 19 的测试
          echo "Running React 19 specific tests..."
          
  build-and-publish:
    name: Build and Publish
    runs-on: ubuntu-latest
    needs: [test-react-18, test-react-19]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/'))
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: Build React 18 version (default)
        run: |
          yarn build
          
      - name: Build React 19 version
        run: |
          node scripts/react19-build.js 19
          
      - name: Create React 19 package.json
        run: |
          # 复制并修改 package.json 为 React 19 版本
          cp packages/semi-ui/package.json packages/semi-ui-19/package.json
          
          # 使用 jq 修改包名和依赖版本
          cd packages/semi-ui-19
          npx json -I -f package.json -e 'this.name="@douyinfe/semi-ui-19"'
          npx json -I -f package.json -e 'this.peerDependencies.react="^19.0.0"'
          npx json -I -f package.json -e 'this.peerDependencies["react-dom"]="^19.0.0"'
          
      - name: Publish React 18 version
        run: |
          cd packages/semi-ui
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          
      - name: Publish React 19 version
        run: |
          cd packages/semi-ui-19
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }} 